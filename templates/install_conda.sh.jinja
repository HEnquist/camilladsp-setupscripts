{# Full setup on Linux and MacOS using conda -#}
{% extends "install_base.sh.jinja" %}

{% block setup_python_env %}
if [[ -z $CONDA_PREFIX ]]; then
    echo "CONDA_PREFIX environment variable is not set, looking for conda in standard locations"
    if [ -f ~/opt/anaconda3/etc/profile.d/conda.sh ]; then
        echo "Using user Anaconda at ~/opt/anaconda3"
        source ~/opt/anaconda3/etc/profile.d/conda.sh
    elif [ -f ~/anaconda3/etc/profile.d/conda.sh ]; then
        echo "Using user Anaconda at ~/anaconda3"
        source ~/anaconda3/etc/profile.d/conda.sh
    elif [ -f /opt/anaconda3/etc/profile.d/conda.sh ]; then
        echo "Using system Anaconda at /opt/anaconda3"
        source /opt/anaconda3/etc/profile.d/conda.sh
    elif [ -f ~/opt/miniconda3/etc/profile.d/conda.sh ]; then
        echo "Using user miniconda at ~/opt/miniconda3"
        source ~/opt/miniconda3/etc/profile.d/conda.sh
    elif [ -f ~/miniconda3/etc/profile.d/conda.sh ]; then
        echo "Using user miniconda at ~/miniconda3"
        source ~/miniconda3/etc/profile.d/conda.sh
    elif [ -f ~/opt/miniforge3/etc/profile.d/conda.sh ]; then
        echo "Using user miniforge at ~/opt/miniforge3"
        source ~/opt/miniforge3/etc/profile.d/conda.sh
    elif [ -f ~/miniforge3/etc/profile.d/conda.sh ]; then
        echo "Using user miniforge at ~/miniforge3"
        source ~/miniforge3/etc/profile.d/conda.sh
    else
        echo "No conda found!"
        exit 1
    fi
else
    echo "Using conda from $CONDA_PREFIX"
    source $CONDA_PREFIX/etc/profile.d/conda.sh
fi

conda activate camillagui
if [ $? -eq 0 ]; then
    echo "Updating existing environment"
    conda env update -f cdsp_conda.yml --prune
else
    echo "Creating new environment"
    conda env create -f cdsp_conda.yml
    conda activate camillagui
fi
{% endblock setup_python_env %}
